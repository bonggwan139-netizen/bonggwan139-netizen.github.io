<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>DBC | ì§€ë„</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { margin:0 }
    #map { height: 100vh; }

    /* ì¢Œì¸¡ ìƒë‹¨ ë ˆì´ì–´ ì»¨íŠ¸ë¡¤ ê¸°ë³¸ ìŠ¤íƒ€ì¼ ìœ ì§€ */

    /* ìš°ì¸¡ ìƒë‹¨: ë°©ìœ„(ì»´í¼ìŠ¤) â€“ ì•„ì´ì½˜ì„ ì‘ê²Œ(ê¸°ì¡´ì˜ 1/2) */
    .leaflet-control.compass.leaflet-bar {
      background:#fff; border:1px solid #ccc; border-radius:6px;
      padding:4px 6px; box-shadow:0 1px 3px rgba(0,0,0,.15); font:12px/1.2 system-ui;
    }
    .compass .arrow-wrap {
      width:30px; height:30px; display:flex; align-items:center; justify-content:center;
    }
    .compass .label { text-align:center; font-weight:700; color:#333; font-size:10px; margin-top:2px; }
  </style>
</head>
<body>
  <header style="border-bottom:1px solid #eee; position:sticky; top:0; background:#fff; z-index:1000;">
    <nav style="max-width:1000px; margin:0 auto; padding:14px 20px; display:flex; gap:16px; align-items:center;">
      <strong style="font-size:18px;">DBC</strong>
      <a href="index.html">í™ˆ</a>
      <a href="about.html">ì†Œê°œ</a>
      <a href="map.html"><b>ì§€ë„</b></a>
    </nav>
  </header>

<div id="search-bar" style="position:relative; z-index:1001; background:#fff; border-bottom:1px solid #eee;">
    <div style="max-width:1000px; margin:0 auto; padding:8px 20px; display:flex; gap:8px; align-items:center;">
      <label for="pnu-input" style="font-size:14px;">PNU</label>
      <input id="pnu-input" type="text" placeholder="ì˜ˆ: 5011010100110920010"
             style="flex:1; padding:6px 8px; border:1px solid #ccc; border-radius:4px; font-size:13px;">
      <button id="pnu-btn"
              style="padding:6px 10px; border-radius:4px; border:1px solid #0366d6; background:#0366d6; color:#fff; font-size:13px; cursor:pointer;">
        ê²€ìƒ‰
      </button>
    </div>
  </div>
  
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const KEY = "3C11E290-3F00-3957-8B03-FB4CB582692F";  // VWorld í‚¤
    const COMPASS_RGB = "18, 52, 102";                    // ë°©ìœ„ í™”ì‚´í‘œ ìƒ‰
    const API_BASE_URL = "http://127.0.0.1:8000";         // FastAPI ì„œë²„ ì£¼ì†Œ
    const PARCEL_ZOOM_THRESHOLD = 10;

    // ì§€ë„ ìƒì„± (ì œì£¼íŠ¹ë³„ìì¹˜ë„ì²­ ì¤‘ì‹¬)
    const map = L.map('map', { zoomControl: true }).setView([33.4890, 126.4983], 13);

    // ----- ë² ì´ìŠ¤ë§µ -----
    const street = L.tileLayer(
      `https://api.vworld.kr/req/wmts/1.0.0/${KEY}/Base/{z}/{y}/{x}.png`,
      { maxZoom: 19, attribution: '&copy; VWorld' }
    );
    const satellite = L.tileLayer(
      `https://api.vworld.kr/req/wmts/1.0.0/${KEY}/Satellite/{z}/{y}/{x}.jpeg`,
      { maxZoom: 19, attribution: '&copy; VWorld' }
    );
    street.addTo(map);

    // ----- ë ˆì´ì–´ ì„ íƒ(ì¢Œì¸¡ ìƒë‹¨) : ì¼ë°˜ / ìœ„ì„± -----
    L.control.layers({ 'ì¼ë°˜': street, 'ìœ„ì„±': satellite }, {}, { position:'topleft', collapsed:false }).addTo(map);

    // ----- ë°©ìœ„(ìš°ì¸¡ ìƒë‹¨) -----
    const CompassControl = L.Control.extend({
      options: { position: 'topright' },
      onAdd: function () {
        const container = L.DomUtil.create('div', 'leaflet-control compass leaflet-bar');
        container.innerHTML = `
          <div class="arrow-wrap">
            <svg width="30" height="30" viewBox="0 0 30 30" aria-label="north">
              <polygon points="15,2 26,26 15,21 4,26" fill="rgb(${COMPASS_RGB})"></polygon>
            </svg>
          </div>
          <div class="label">N</div>
        `;
        L.DomEvent.disableClickPropagation(container);
        L.DomEvent.disableScrollPropagation(container);
        return container;
      }
    });
    map.addControl(new CompassControl());

    // ----- ì¶•ì²™(ìš°ì¸¡ í•˜ë‹¨, ë¯¸í„° ë‹¨ìœ„) -----
    L.control.scale({ position: 'bottomright', metric: true, imperial: false }).addTo(map);

    // ====== ì—¬ê¸°ì„œë¶€í„° BBOX ì•ˆ í•„ì§€ ìë™ ë¡œë”© ======
    const parcelLayer = L.geoJSON(null, {
      style: {
        color: '#ff0000',
        weight: 2,
        fillOpacity: 0.2
      },
      onEachFeature: (feature, layer) => {
        if (feature.properties) {
          const p = feature.properties;
          layer.bindPopup(
            `<div style="font-size:12px;">
              <div><b>PNU</b>: ${p.pnu}</div>
              <div><b>ì£¼ì†Œ</b>: ${p.address ?? ''}</div>
              <div><b>ì§€ëª©</b>: ${p.jimok_nm ?? ''}</div>
              <div><b>ë©´ì (ã¡)</b>: ${p.area_m2 ?? ''}</div>
              <div><b>ê³µì‹œì§€ê°€</b>: ${p.land_price ?? ''}</div>
            </div>`
          );
        }
      }
    }).addTo(map);

    async function loadParcelsInView() {
  const zoom = map.getZoom();

  // ğŸ”¸ íŠ¹ì • ì¤Œ ì´ìƒì¼ ë•Œë§Œ í•„ì§€ ë³´ì´ê²Œ (í•œ ë²ˆì— ë‚˜íƒ€ë‚˜ëŠ” ëŠë‚Œ)
  if (zoom < PARCEL_ZOOM_THRESHOLD) {
    parcelLayer.clearLayers();
    return;
  }

  const bounds = map.getBounds();
        return;
      }

      const bounds = map.getBounds();
      const min_lon = bounds.getWest();
      const min_lat = bounds.getSouth();
      const max_lon = bounds.getEast();
      const max_lat = bounds.getNorth();

      const url = `${API_BASE_URL}/parcels_bbox` +
                  `?min_lon=${min_lon}&min_lat=${min_lat}` +
                  `&max_lon=${max_lon}&max_lat=${max_lat}` +
                  `&limit=500`;

      try {
        const res = await fetch(url);
        if (!res.ok) {
          console.error("bbox ìš”ì²­ ì‹¤íŒ¨:", res.status);
          return;
        }

        const fc = await res.json();   // FeatureCollection
        parcelLayer.clearLayers();
        parcelLayer.addData(fc);       // ì—¬ëŸ¬ í•„ì§€ë¥¼ í•œ ë²ˆì— ê·¸ë¦¼
      } catch (err) {
        console.error("bbox ìš”ì²­ ì¤‘ ì˜¤ë¥˜:", err);
      }
    }

    // ì§€ë„ ì´ë™/í™•ëŒ€ ëë‚  ë•Œë§ˆë‹¤ í˜„ì¬ í™”ë©´ ë²”ìœ„ í•„ì§€ ë¡œë”©
    map.on("moveend", loadParcelsInView);

    // ë§µ ì²˜ìŒ ë¡œë”©ë  ë•Œë„ í•œ ë²ˆ í˜¸ì¶œ
    map.whenReady(loadParcelsInView);
  </script>
</body>
</html>
