<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>DBC | 지도</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { margin:0 }
    #map { height: 100vh; }

    /* 좌측 상단 레이어 컨트롤 기본 스타일 유지 */

    /* 우측 상단: 방위(컴퍼스) – 아이콘을 작게(기존의 1/2) */
    .leaflet-control.compass.leaflet-bar {
      background:#fff; border:1px solid #ccc; border-radius:6px;
      padding:4px 6px; box-shadow:0 1px 3px rgba(0,0,0,.15); font:12px/1.2 system-ui;
    }
    .compass .arrow-wrap {
      width:30px; height:30px; display:flex; align-items:center; justify-content:center;
    }
    .compass .label { text-align:center; font-weight:700; color:#333; font-size:10px; margin-top:2px; }
  </style>
</head>
<body>
  <header style="border-bottom:1px solid #eee; position:sticky; top:0; background:#fff; z-index:1000;">
    <nav style="max-width:1000px; margin:0 auto; padding:14px 20px; display:flex; gap:16px; align-items:center;">
      <strong style="font-size:18px;">DBC</strong>
      <a href="index.html">홈</a>
      <a href="about.html">소개</a>
      <a href="map.html"><b>지도</b></a>
    </nav>
  </header>

<div id="search-bar" style="position:relative; z-index:1001; background:#fff; border-bottom:1px solid #eee;">
    <div style="max-width:1000px; margin:0 auto; padding:8px 20px; display:flex; gap:8px; align-items:center;">
      <label for="pnu-input" style="font-size:14px;">PNU</label>
      <input id="pnu-input" type="text" placeholder="예: 5011010100110920010"
             style="flex:1; padding:6px 8px; border:1px solid #ccc; border-radius:4px; font-size:13px;">
      <button id="pnu-btn"
              style="padding:6px 10px; border-radius:4px; border:1px solid #0366d6; background:#0366d6; color:#fff; font-size:13px; cursor:pointer;">
        검색
      </button>
    </div>
  </div>
  
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const KEY = "3C11E290-3F00-3957-8B03-FB4CB582692F";  // VWorld 키
    const COMPASS_RGB = "18, 52, 102";                    // 방위 화살표 색
    const API_BASE_URL = "http://127.0.0.1:8000";         // FastAPI 서버 주소

    // 지도 생성 (제주특별자치도청 중심)
    const map = L.map('map', { zoomControl: true }).setView([33.4890, 126.4983], 13);

    // ----- 베이스맵 -----
    const street = L.tileLayer(
      `https://api.vworld.kr/req/wmts/1.0.0/${KEY}/Base/{z}/{y}/{x}.png`,
      { maxZoom: 19, attribution: '&copy; VWorld' }
    );
    const satellite = L.tileLayer(
      `https://api.vworld.kr/req/wmts/1.0.0/${KEY}/Satellite/{z}/{y}/{x}.jpeg`,
      { maxZoom: 19, attribution: '&copy; VWorld' }
    );
    street.addTo(map);

    // ----- 레이어 선택(좌측 상단) : 일반 / 위성 -----
    L.control.layers({ '일반': street, '위성': satellite }, {}, { position:'topleft', collapsed:false }).addTo(map);

    // ----- 방위(우측 상단) -----
    const CompassControl = L.Control.extend({
      options: { position: 'topright' },
      onAdd: function () {
        const container = L.DomUtil.create('div', 'leaflet-control compass leaflet-bar');
        container.innerHTML = `
          <div class="arrow-wrap">
            <svg width="30" height="30" viewBox="0 0 30 30" aria-label="north">
              <polygon points="15,2 26,26 15,21 4,26" fill="rgb(${COMPASS_RGB})"></polygon>
            </svg>
          </div>
          <div class="label">N</div>
        `;
        L.DomEvent.disableClickPropagation(container);
        L.DomEvent.disableScrollPropagation(container);
        return container;
      }
    });
    map.addControl(new CompassControl());

    // ----- 축척(우측 하단, 미터 단위) -----
    L.control.scale({ position: 'bottomright', metric: true, imperial: false }).addTo(map);

    // ====== 여기서부터 BBOX 안 필지 자동 로딩 ======
    const parcelLayer = L.geoJSON(null, {
      style: {
        color: '#ff0000',
        weight: 2,
        fillOpacity: 0.2
      },
      onEachFeature: (feature, layer) => {
        if (feature.properties) {
          const p = feature.properties;
          layer.bindPopup(
            `<div style="font-size:12px;">
              <div><b>PNU</b>: ${p.pnu}</div>
              <div><b>주소</b>: ${p.address ?? ''}</div>
              <div><b>지목</b>: ${p.jimok_nm ?? ''}</div>
              <div><b>면적(㎡)</b>: ${p.area_m2 ?? ''}</div>
              <div><b>공시지가</b>: ${p.land_price ?? ''}</div>
            </div>`
          );
        }
      }
    }).addTo(map);

    async function loadParcelsInView() {
      const zoom = map.getZoom();

      // 너무 멀리서 보면 로딩 안 함 (서버 보호용)
      if (zoom < 14) {
        parcelLayer.clearLayers();
        return;
      }

      const bounds = map.getBounds();
      const min_lon = bounds.getWest();
      const min_lat = bounds.getSouth();
      const max_lon = bounds.getEast();
      const max_lat = bounds.getNorth();

      const url = `${API_BASE_URL}/parcels_bbox` +
                  `?min_lon=${min_lon}&min_lat=${min_lat}` +
                  `&max_lon=${max_lon}&max_lat=${max_lat}` +
                  `&limit=500`;

      try {
        const res = await fetch(url);
        if (!res.ok) {
          console.error("bbox 요청 실패:", res.status);
          return;
        }

        const fc = await res.json();   // FeatureCollection
        parcelLayer.clearLayers();
        parcelLayer.addData(fc);       // 여러 필지를 한 번에 그림
      } catch (err) {
        console.error("bbox 요청 중 오류:", err);
      }
    }

    // 지도 이동/확대 끝날 때마다 현재 화면 범위 필지 로딩
    map.on("moveend", loadParcelsInView);

    // 맵 처음 로딩될 때도 한 번 호출
    map.whenReady(loadParcelsInView);
  </script>
</body>
</html>
